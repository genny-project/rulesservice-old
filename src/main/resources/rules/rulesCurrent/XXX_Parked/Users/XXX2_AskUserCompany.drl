package life.genny.rules;

import life.genny.rules.QRules;


rule "Ask First User Company"
    no-loop true
	salience 9
    agenda-group "NewUserProfile"
    when
        rules: QRules( !isState("NUP2") && isState("PROFILE_NOT_COMPLETED") ) 
     then
     	rules.header();
     	rules.debug();   		
   	    String userCode = rules.getUser().getCode(); 
  	  /*  Check if user is already added to the company   */
        BaseEntity company = rules.getParent(userCode, "LNK_STAFF");
        String companyCode = "";
        if(company != null)
        {
           rules.println("Company Found");
           rules.println("Company BE is  :: "+company.toString());
            companyCode = company.getCode();
         /*   rules.askQuestions(userCode, companyCode, "QUE_USER_COMPANY_GRP"); */
            
        }
        if(company == null)
        {
           rules.println("Company Not Found, Creating New Company");
           /*  Creating new base-entity Company    */
           BaseEntity newCompany = QwandaUtils.createBaseEntityByCode(QwandaUtils.getUniqueId(userCode, null, "CPY", rules.getToken()), "COMPANY", rules.getQwandaServiceUrl(), rules.getToken());
           companyCode = newCompany.getCode();
           /*  link new person to the Company    */
           Link userCompanyLink =  QwandaUtils.createLink(companyCode, userCode, "LNK_STAFF", null, (double) 1, rules.getToken());
      
        }
       
        rules.askQuestions(userCode, companyCode, "QUE_NEW_USER_COMPANY_GRP");

   	    rules.setState("NUP2");
	    rules.footer();     		      
end
